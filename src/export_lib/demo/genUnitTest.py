#!/usr/bin/python
import xml.dom.minidom
import sys

xmlPath = "API.xml"
xmlDoc = xml.dom.minidom.parse(xmlPath)
dstPath = "Tester/main.cpp"
f = open(dstPath, "w")
'''
get the module name
'''
module_name = xmlDoc.getElementsByTagName("module")
'''
parse api section
'''
allLines = "/*generated by gencode.py\n *author: bill xia\n */\n\n#include <stdio.h>\n#include \"common.h\"\n\n" + "#include \"" + module_name[0].firstChild.data + ".h\"\n"
allLines = allLines + "int main()\n{\n    char result[10240];\n    int ret = 0;\n    int len = 10240;\n    int total_case = 0;\n    int fail_case = 0;\n"
apis = xmlDoc.getElementsByTagName("api");

for api in apis:
    '''
    build contents iteratively
    sp1: function name
    '''
    '''
    get the type names
    '''
    protype = api.childNodes[3];
    
    params = protype.getElementsByTagName("param")
    type_names = []
    counter = 0
    for param in params: 
    	type_name = ""
        if param.getElementsByTagName("type"):
            type_name = param.childNodes[1].firstChild.data
            type_names.append(type_name)
    
    api_name = api.childNodes[1]
    prefix = ""
    prefix = "\n    ret = " + api_name.firstChild.data + '('
    
    testcases = api.getElementsByTagName("testcase")
    
    for testcase in testcases:
        expected = testcase.childNodes[3].firstChild.data
        caseId = testcase.childNodes[1].firstChild.data
        params = testcase.getElementsByTagName("param")
        counter = 0
        line = ""
        for param in params:
            if counter == 0:
                line = line + param.firstChild.data
            else:
                line = line + ", " + param.firstChild.data
            counter = counter + 1
            
        for type_name in type_names:
            print "test=> " + type_name
            if type_name == "outdata":
                if counter > 0:
                    line = line + ", result, &len"
                else:
                    line = line + "result, &len"
                break
                
        line = line + ");\n"
        
        allLines = allLines + prefix + line
        allLines = allLines + "    if (ret != " + expected + ") {\n        printf(\"caseId:" + caseId + "\tret = %d\tError\\n\", ret);\n        fail_case++;\n    }\n"
	allLines = allLines + "    total_case++;\n\nlen = 10240;\n\n";

allLines = allLines + "    printf(\"total case: %d\\n fail case:%d\", total_case, fail_case);\n"
allLines = allLines + "    return 0;\n}\n"
f.write(allLines)
f.close()
        
